<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout</title>
    <link rel="stylesheet" href="styles.css">
    <script>
        // This function will handle the logic after payment (or simulated payment for now)
        async function processDispense() {
            const submitButton = document.getElementById("submitPayment");
            const statusMessageElement = document.getElementById("statusMessage");

            if (!statusMessageElement) {
                console.error("statusMessage element not found in checkout.html!");
                alert("Error: Status message display area is missing."); // User feedback
                return;
            }
            if (!submitButton) {
                console.error("submitPayment button not found in checkout.html!");
                return;
            }

            statusMessageElement.textContent = 'Processing your request... Please wait.';
            submitButton.disabled = true;
            submitButton.style.backgroundColor = '#ccc'; // Visually indicate disabled

            // --- Future Payment Gateway Integration Point ---
            // For now, we assume payment is successful and proceed to dispense.
            // In a real scenario, your Cloudflare Worker would likely be called *after*
            // a payment gateway confirms successful payment via a webhook to another Worker endpoint.
            // This current flow directly calls a worker assumed to trigger dispense.

            try {
                // IMPORTANT: Replace this with your ACTUAL Cloudflare Worker URL for dispensing!
                const workerUrl = 'https://connection.auhydis-api.workers.dev/dispense'; // EXAMPLE PLACEHOLDER URL

                const response = await fetch(workerUrl, {
                    method: 'POST', // Using POST is good practice for actions
                    // If your worker expects a body (e.g., item ID, cart details):
                    // headers: { 'Content-Type': 'application/json' },
                    // body: JSON.stringify({ cart: JSON.parse(localStorage.getItem('cart') || '[]') })
                });

                if (response.ok) {
                    const data = await response.json(); // Assuming worker returns JSON e.g. { success: true, message: "Dispensing!" }
                    statusMessageElement.textContent = data.message || "Dispense signal sent! Your item is being vended.";
                    statusMessageElement.style.color = 'green';

                    // Redirect to success page after a short delay
                    setTimeout(() => {
                        window.location.href = 'success.html';
                    }, 3000); // Wait 3 seconds before redirecting to allow user to read message

                } else {
                    // Try to get error message from worker response
                    let errorMessage = `Failed to trigger motor. Status: ${response.status}`;
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.message || errorMessage;
                    } catch (e) { /* Ignore if response is not JSON */ }
                    
                    statusMessageElement.textContent = errorMessage;
                    statusMessageElement.style.color = 'red';
                    submitButton.disabled = false; // Re-enable button on failure
                    submitButton.style.backgroundColor = ''; // Reset button color
                }
            } catch (error) {
                console.error("Error triggering motor:", error);
                statusMessageElement.textContent = "Error: Could not connect to the dispense service. Please check your internet connection.";
                statusMessageElement.style.color = 'red';
                submitButton.disabled = false; // Re-enable button on failure
                submitButton.style.backgroundColor = ''; // Reset button color
            }
        }

        document.addEventListener("DOMContentLoaded", function() {
            const submitButton = document.getElementById("submitPayment");
            if (submitButton) {
                submitButton.addEventListener("click", processDispense);
            } else {
                console.error("Submit Payment button not found on checkout.html during DOMContentLoaded.");
            }

            // Display cart items from localStorage on the checkout page
            const cartItemsElement = document.getElementById('cart-items');
            const totalPriceElement = document.getElementById('total-price');

            if (cartItemsElement && totalPriceElement) {
                const savedCart = localStorage.getItem('cart');
                if (savedCart) {
                    const cart = JSON.parse(savedCart);
                    cartItemsElement.innerHTML = ''; // Clear previous items
                    let total = 0;
                    if (cart.length > 0) {
                        cart.forEach(item => {
                            const li = document.createElement('li');
                            li.textContent = `${item.product} - ${item.quantity} pcs - ₱${(item.price * item.quantity).toFixed(2)}`;
                            cartItemsElement.appendChild(li);
                            total += item.price * item.quantity;
                        });
                        totalPriceElement.textContent = `Total: ₱${total.toFixed(2)}`;
                    } else {
                        cartItemsElement.innerHTML = '<li>Your cart is empty.</li>';
                        totalPriceElement.textContent = 'Total: ₱0.00';
                    }
                } else {
                    cartItemsElement.innerHTML = '<li>Your cart is empty.</li>';
                    totalPriceElement.textContent = 'Total: ₱0.00';
                }
            } else {
                if (!cartItemsElement) console.error("Element with ID 'cart-items' not found for cart display.");
                if (!totalPriceElement) console.error("Element with ID 'total-price' not found for cart display.");
            }
        });
    </script>
</head>

<body>
    <div class="top-bar" id="top-bar">
        <a href="https://auhydis.com/"> 
            <img src="images/logo.png" alt="Auhydis Logo">
        </a>
    </div>

    <header>
        <h1>Checkout</h1>
    </header>

    <main>
        <section>
            <h2>Cart Summary</h2>
            <ul id="cart-items"></ul> <p id="total-price"></p> </section>

        <section>
            <button id="submitPayment">Submit Payment & Dispense</button>
            <p id="statusMessage" style="margin-top: 15px; font-weight: bold;"></p> </section>
    </main>

    </body>
</html>
